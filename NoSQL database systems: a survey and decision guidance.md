# NoSQL database systems: a survey and decision guidance

# 摘要
今天，数据正在以史无前例的规模被生成并且被消费。这种情况催生了面向持续增上的数据和请求的基于"NoSQL"的可扩展数据管理系统。但是，现有的系统的异构性和多样性使得在面对一个给定的应用上下文进行数据存储选型非常困难。因此，这篇文章从上层视角进行概括：我们并不打算深入对比每个系统的详细的实现特性，我们提供了一个  将功能和非功能的需求与NoSQL数据库中的技术和算法结合起来的比较分类模型。这个NoSQL工具箱使得我们可以根据一个简单的决策树来帮助从业者和研究者根据关键的应用需求过滤出潜在的备选系统。

# 1 介绍
通过几十年的发展，传统的关系型数据库管理系统(RDBMS) 对存储和查询结构化数据提供了涉及：`强一致、事务保证、很高级别的数据可靠性、稳定性等方面 `一套非常强悍的机制。近些年来，一些应用领域处理的有效的数量量已经变得如此巨大以至于通过创痛的数据库方案无法被存储以及处理。社交网络中的用户生成内容，大型网络传感器采集的数据 仅仅是大数据的两个典型的样例。一类可以用来处理大数据的新型的数据存储系统被统一称为：NoSQL数据库，其中很多系统通过牺牲查询能力和一致性保障提供相比关系型数据库更好的水平可扩展和高可用能力。因为任何有状态服务只能和其底层的数据存储具有一样的可扩展和容错能力，这种折衷对于面向服务的计算和作为服务的模型来讲非常关键，

目前有数十个NoSQL数据库系统,由于实现细节变化很快并且系统特性也随着时间变化不断演进，这些系统很难分清出处理其各自适合什么场景? 怎么处理失败? 甚至他们有哪些不同。这篇文章中，我同通过面向应用概念而不是系统特性并且结合NoSQL数据系统的自身需求、实现这些需求的技术需求以及过程中的折衷来对NoSQL的格局进行一个概要展示。我们主要聚焦在：`key-value，文档和宽-列存储`，这几种存储NoSQL类别从数据可扩展性管理上已经覆盖了绝大多数相关技术和设计决策。

第2部分，我们通过key-value存储、文档存储、宽-列存储等存储模型以及设计思想（CAP 以及PACELC）上safety-liveness的折衷两个维度来对NoSQL数据库系统进行分类来提供一种通用分类。
然后在第3部分我们更详细的调研使用到的技术并且描述需求如何和技术相关联。
第4部分通过应用我们的模型我们给出了一个数据库系统核心特征的广泛概述。
最终第5部分总结出根据应用需求来选择合适的NoSQL系统的一个简单和抽象的决策模型。

# 2 整体系统分类
为了对不同的NoSQL系统实现细节进行抽象，我们使用整体分类标准将数据存储分门别类。这一部分，我们使用两个主要分类标准：数据模型 以及 CAP理论。

## 2.1 数据模型分类标准
### 2.1.1  key-value 存储
一个key-value存储包含一些列具有不同key值的key-value序对。由于这个简单的结构，系统只支持get和put操作。存储的数据相对数据库是透明的特性，纯粹的key-value存储不支持CRUD（create、read、update、delete）之外的其他操作。key-value存储因此被认为：没有语义模式（schemaless）：存储数据的结构默认由应用程序在上层进行编码(schema-on-read)并且无法通过一个数据定义语言显示定义（schema-on-write）。
```
思考：关键词：无模式、只支持CRUD操作、value为编码后字节流上层理解
目前见到的key-value形式的存储：
磁盘介质：tdb、tssd
内存介质：tair、dcache、redis
```

这种数据模型的显著的优势就是简单性。非常简单的抽象使得数据分区和查询非常容易，这样数据库系统也能实现低延迟和高吞吐。但是，如果应用需要更复杂的操作，比如：范围查询，这种数据模型将不再有效。表1展示用户账户数据和设置是如何在key-value存储系统中存储中。由于比简单查询更复杂的查询无法被支持。数据只能在应用层通过解码分析才能抽取出像：是否支持cookie这样的信息。
![key-value和document格式的nosql](https://github.com/sandszhouSZ/PaperTranslate/blob/EditBranch/image/Nosql-1-2.png)

### 2.1.2  文档存储
一个文档存储是一个value为半结构化（比如JSON）格式的文档类型的key-value存储。这种相比较原生的key-value的约束给访问数据带来很大的灵活性。应用不仅可以通过ID来获取全部的文档内容，而且可以只获取文档的的部分数据。比如：custor的年龄，并且可以执行聚合（计算技术、排序），query-by-example或者甚至是全文查找。
```
思考：关键词：value为半结构格式的key-value文档，用户的使用可扩展性更高，使用形式更灵活、贴近RDBMS。
目前使用到的存储：
mongoDB，ES搜索
```

###2.1.3 宽-列存储
宽列存储取名是从 `其经常被用于解释下面的数据模型：拥有很多稀疏列的一个关系表 `得来。但是，从技术上看一个宽-列存储和一个分布式的多层有序map非常类似(比如对于Bigtable：多层体现在：行、列、时间戳 -> data):第一层的key标识表中的row，被称为:行关键字，第二级的key被称为：列关键字。由于没有数据时就不会有列key，这种存储模式使得拥有任意多列非常容易。所以，null值可以不用花费任何开销进行存储。所有的列被分为称为：列族，同一列族的相关列一般都是同时访问，其可以存储在磁盘上临近位置。在磁盘上，宽-列存储并不能colocate每个行的所有数据而是colocate相同行相同列族的数据。所以，一个实体（row）在一个文档存储中不能只通过一次查找就能获取到。但是通过所有的列族的列聚合起来。但是，这种存储布局通常可以保证高度有效的数据压缩同时使得获取一个实体的一部分非常有效。数据通过key的字典序排序，所以通过自己的设计key值可以使得临近的数据的访问基本是物理上临近的。由于所有的行被分割为连续的范围（称为tablet）并且分布到不同的分片节点，行扫描一般只涉及很少的节点所以会非常高效。
```
思考： 关键词：有存储模式，具有为稀疏列的大表，多级key，压缩
目前使用到的存储:
Bigtable、HBase
```
![宽列存储](https://github.com/sandszhouSZ/PaperTranslate/blob/EditBranch/image/Nosql-wide-column.png)
Google为了存储大量网页特别开发Bigtable代表了宽-列存储模型，如图标3。网页表的每一行代表了一个特数据网页。行关键字是URL组件的反转级联组成，而且每个列关键字包含了：列族的名字和列通配符，其通过分好链接在一起。这里有两个列族：内容列族只包含一列用以存储真实的网页数据；anchor列族包含了到每个网页的连接，每个都是单独一列。表中的每个单元（行和列组合对应的数据）都可以通过时间戳或者版本号来被版本化。明确一个时间的多数信息不仅仅通过value而且是是通过key来表达。

## 22 一致性-可用性折衷：CAP 和 PACELC
```
思路：
CAP
关键点：CAP存在的前提是：分布式系统，即多个节点可同时接收多个client的read、write请求。离开这个前提讨论将无意义。
CAP理论表明，在出现P时，CAP只能二选一，下面列举作者见到的实际系统的选择：

PC: 一致性优先，在出现网络分区时，保证一致性和可用性，系统将停止服务。比如ChxMaster单Master系统。
PA： 可用性优先，Danamo系统 NRW，写多数即可以，出现分区的节点仍然在对client提供服务。
------------------------------------------------------------------------------------
PACELC：
  如果存在分区场景，需要在可用性(A)和一致性(C)之间权衡
  否则，需要在延迟(L)和一致性(C)之间权衡
```
除了数据如何存储以及如何获取外描述数据库特性的另一个手段就是其提供的一致性。一些数据库被设计来保证强一致和串行化（ACID）（Atmoic、Consistency、Isolation、Duration），另一些数据库更倾向于可用性（BASE： Basically Available，Soft-state，Eventually consistent）。这种折衷被每个分布式数据库系统所继承而且大量的不同的NoSQL系统表明在这两个范式中都有很多实现形态。接下来，我们婵说CAP理论和PACELC理论并根据一致性模型对数据库系统进行分类。

CAP类似于著名的FLP理论，CAP理论由Eric Brewer在PODC 2000年提出并被Gilbert和Lynch证明。由于其给出了分布式系统可能完成的终极上限，其是分布式计算领域真正有影响的不可能理论。CAP理论描述：`a sequentially consistent read/write register【一种数据结构】 that eventually
responds to every request`是不能在一个存在网络分区的异步系统实现的。换句话说，CAP只能保证下面三个特性中的两个：
- 一致性（C）： 读和写一直是原子的执行并且严格一致，换句话说，所有的client端在任何时刻看到的是同一份数据。

- 可用性（A）：系统中的每个非异常节点一直可以接受读和写请求并且最终返回一个有意义的结果，比如不会返回错误信息。

- Partition-tolerance(P): 系统在节点间存在消息丢失或者部分节点异常时仍然对外提供之前一致性保证和可用性。

Brewer主张一个系统在正常的操作中可以既保证可用性和一致性，但是如果出现系统分区，这是不可能的：如果一个系统在存在分区时继续工作，存在一些没有异常的节点会和其他节点丢失联系，所以该节点决定或者继续处理client的请求来保证可用性（AP，最终一致的系统）或者拒绝client的请求来保证一致性（CP）。第一个选择会违背一致性，因为这样会导致无效的读以及冲突的写，同时第二个选择会牺牲可用性。也有系统保证高可用和一致的，但是当存在分区时（CA）全部失败，比如单节点系统。已经证明保证一致性的CAP理论至少是因果一致性，包含一定的数据陈旧。Serializability（事务隔离性的正确标准）并不需要很强的一致性。然而，和一致性类似，操作的串行性在网络分区时也无法实现。

NoSQL系统的根据每个系统的能力分为：AP,CP,CA，这也是被广泛接受的系统分类标准。但是，需要强调的是`CAP理论在正在的操作中是没有任何意义`；只有在遇到网络分区时CAP理论也仅仅高速我们一个系统是更要倾向于可用性还是一致性。 与FLP-理论对比，CAP理论是一个允许任意消息被记录、被丢弃，或者被无限延迟的模型。对网络信道可能存在各种问题的假定（消息经常会异步的并且乱序的到达），一个CAP系统可以用theAttiya, Bar-Noy, Dolev算法（只要大多数节点存活）来保证。

PACELC由Daniel Abadi提出，强调CAP理论在正常操作中 在`延迟和一致性`两方面没法达成一致。尽管相比在异常场景下的可用性-一致性折衷方面CAP在分布式系统的设计有很大的影响。他将 折衷 和 更精确的刻画分布式系统的设计理念 相结合提出了PACELC。从FPACELC,我们了解到，在出现系统分区时，需要可用性和一致性的权衡，否则就是正常的操作，系统只有延迟和一致性的折衷。

这种分类在出现分区场景时基本上提供了（A/C）之间两种可能的选择，并且在正常时候提供了另外两个（L/C）之间的选择。相比CAP理论更加精细。但是，很多系统不能被严格的分配给某一个PACELC子类。并且PACELC分类中的一个子类，比如PC/EL没有任何一个现有的系统可以对应。


